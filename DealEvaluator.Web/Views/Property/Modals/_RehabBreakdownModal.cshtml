@model DealEvaluator.Web.Models.PropertyDetailsViewModel

@if (Model.LatestEvaluation?.RehabEstimate?.LineItems?.Any() == true)
{
    <div class="modal fade" id="rehabBreakdownModal" tabindex="-1" aria-labelledby="rehabBreakdownModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-gradient" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    <h5 class="modal-title fw-bold" id="rehabBreakdownModalLabel">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-tools me-2" viewBox="0 0 16 16">
                            <path d="M1 0 0 1l2.2 3.081a1 1 0 0 0 .815.419h.07a1 1 0 0 1 .708.293l2.675 2.675-2.617 2.654A3.003 3.003 0 0 0 0 13a3 3 0 1 0 5.878-.851l2.654-2.617.968.968-.305.914a1 1 0 0 0 .242 1.023l3.27 3.27a.997.997 0 0 0 1.414 0l1.586-1.586a.997.997 0 0 0 0-1.414l-3.27-3.27a1 1 0 0 0-1.023-.242L10.5 9.5l-.96-.96 2.68-2.643A3.005 3.005 0 0 0 16 3q0-.405-.102-.777l-2.14 2.141L12 4l-.364-1.757L13.777.102a3 3 0 0 0-3.675 3.68L7.462 6.46 4.793 3.793a1 1 0 0 1-.293-.707v-.071a1 1 0 0 0-.419-.814zm9.646 10.646a.5.5 0 0 1 .708 0l2.914 2.915a.5.5 0 0 1-.707.707l-2.915-2.914a.5.5 0 0 1 0-.708M3 11l.471.242.529.026.287.445.445.287.026.529L5 13l-.242.471-.026.529-.445.287-.287.445-.529.026L3 15l-.471-.242L2 14.732l-.287-.445L1.268 14l-.026-.529L1 13l.242-.471.026-.529.445-.287.287-.445.529-.026z"/>
                        </svg>
                        Rehab Cost Breakdown
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- Summary Cards -->
                    <div class="p-4 bg-light border-bottom">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="text-center p-3 bg-white rounded shadow-sm">
                                    <div class="text-muted small mb-1">Total Repair Cost</div>
                                    <div class="fs-3 fw-bold text-danger">$@Model.LatestEvaluation.RehabEstimate.TotalCost.ToString("N0")</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 bg-white rounded shadow-sm">
                                    <div class="text-muted small mb-1">Line Items</div>
                                    <div class="fs-3 fw-bold text-primary">@Model.LatestEvaluation.RehabEstimate.LineItems.Count</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 bg-white rounded shadow-sm">
                                    <div class="text-muted small mb-1">Cost per Sqft</div>
                                    @if (Model.Property.Sqft.HasValue && Model.Property.Sqft.Value > 0)
                                    {
                                        var costPerSqft = Model.LatestEvaluation.RehabEstimate.TotalCost / Model.Property.Sqft.Value;
                                        <div class="fs-3 fw-bold text-info">$@costPerSqft.ToString("N2")</div>
                                    }
                                    else
                                    {
                                        <div class="fs-3 fw-bold text-muted">N/A</div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Line Items -->
                    <div class="p-4">
                        <h6 class="fw-bold mb-3 text-muted text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Detailed Breakdown</h6>

                        <div class="row g-3">
                            @foreach (var item in Model.LatestEvaluation.RehabEstimate.LineItems.OrderByDescending(x => x.EstimatedCost))
                            {
                                var percentage = (item.EstimatedCost / (decimal)Model.LatestEvaluation.RehabEstimate.TotalCost) * 100;
                                var badgeColor = item.Condition.ToString() switch
                                {
                                    "Cosmetic" => "bg-success",
                                    "Moderate" => "bg-warning",
                                    "Heavy" => "bg-danger",
                                    _ => "bg-secondary"
                                };

                                <div class="col-12">
                                    <div class="card border-start border-3 border-primary h-100 shadow-sm">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="flex-grow-1">
                                                    <div class="d-flex align-items-center gap-2 mb-1">
                                                        <h6 class="mb-0 fw-bold">@item.LineItemType.ToString()</h6>
                                                        <span class="badge @badgeColor">@item.Condition.ToString()</span>
                                                        <span class="badge bg-light text-dark">@percentage.ToString("N1")% of total</span>
                                                    </div>
                                                    @if (!string.IsNullOrWhiteSpace(item.Notes))
                                                    {
                                                        <p class="text-muted small mb-0 fst-italic">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-chat-left-text me-1" viewBox="0 0 16 16">
                                                                <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                                                                <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5M3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6m0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5"/>
                                                            </svg>
                                                            @item.Notes
                                                        </p>
                                                    }
                                                </div>
                                                <div class="text-end ms-3">
                                                    <div class="fs-4 fw-bold text-primary">$@item.EstimatedCost.ToString("N0")</div>
                                                </div>
                                            </div>

                                            <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                                                <div class="text-muted small">
                                                    <span class="fw-semibold">Quantity:</span> @item.Quantity
                                                </div>
                                                <div class="text-muted small">
                                                    <span class="fw-semibold">Unit Cost:</span> $@item.UnitCost.ToString("N0")
                                                </div>
                                                <div class="text-muted small">
                                                    <span class="fw-semibold">Calculation:</span> @item.Quantity Ã— $@item.UnitCost.ToString("N0")
                                                </div>
                                            </div>

                                            <!-- Visual progress bar showing percentage of total -->
                                            <div class="mt-2">
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar bg-primary" role="progressbar" style="width: @percentage.ToString("N1")%" aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Cost Distribution by Category -->
                        @{
                            var groupedByCondition = Model.LatestEvaluation.RehabEstimate.LineItems
                                .GroupBy(x => x.Condition)
                                .Select(g => new { Condition = g.Key, Total = g.Sum(x => x.EstimatedCost), Count = g.Count() })
                                .OrderByDescending(x => x.Total)
                                .ToList();
                        }

                        @if (groupedByCondition.Any())
                        {
                            <div class="mt-4 pt-3 border-top">
                                <h6 class="fw-bold mb-3 text-muted text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Cost by Condition Type</h6>
                                <div class="row g-2">
                                    @foreach (var group in groupedByCondition)
                                    {
                                        var conditionPercentage = (group.Total / (decimal)Model.LatestEvaluation.RehabEstimate.TotalCost) * 100;
                                        var conditionBadgeColor = group.Condition.ToString() switch
                                        {
                                            "Cosmetic" => "success",
                                            "Moderate" => "warning",
                                            "Heavy" => "danger",
                                            _ => "secondary"
                                        };

                                        <div class="col-md-4">
                                            <div class="card bg-@conditionBadgeColor bg-opacity-10 border-@conditionBadgeColor">
                                                <div class="card-body p-3">
                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                        <span class="badge bg-@conditionBadgeColor">@group.Condition</span>
                                                        <span class="text-muted small">@group.Count items</span>
                                                    </div>
                                                    <div class="fs-5 fw-bold text-@conditionBadgeColor">$@group.Total.ToString("N0")</div>
                                                    <div class="text-muted small">@conditionPercentage.ToString("N1")% of total</div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <div>
                            <small class="text-muted">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-info-circle me-1" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                    <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533z"/>
                                    <path d="M9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
                                </svg>
                                Items sorted by cost (highest first)
                            </small>
                        </div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}